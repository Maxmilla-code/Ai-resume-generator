# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project overview

Scanara is a React 19 + React Router v7 single-page application (SPA) built with TypeScript, Tailwind CSS (v4 via the `@tailwindcss/vite` plugin), and Vite. It integrates tightly with Puter.js for:

- Authentication (`puter.auth`)
- File storage (`puter.fs`) for resume PDFs and generated images
- Key-value storage (`puter.kv`) for analysis metadata
- AI services (`puter.ai`) to call Anthropic Claude for resume analysis

The app runs entirely in the browser (SSR disabled) and talks to Puter as its backend.

## Commands & workflows

All commands are npm scripts defined in `package.json`.

### Install dependencies

```bash
npm install
```

### Run the dev server

```bash
npm run dev
```

This starts the React Router dev server (via `react-router dev`).

### Build for production

```bash
npm run build
```

Uses `react-router build` to create a production build in `build/`.

### Preview / serve the built app

```bash
npm start
```

Uses `react-router-serve ./build/server/index.js` to serve the built app.

### Type checking

```bash
npm run typecheck
```

Runs `react-router typegen` then `tsc` with the project `tsconfig.json`.

### Linting & tests

There are currently **no lint** or **test** scripts configured in `package.json`. Before running tests or linting, set up the relevant tooling (e.g. ESLint, Vitest/Jest) and add scripts.

## High-level architecture

### Tooling & configuration

- **Bundler/dev server**: Vite with React Router integration (`vite.config.ts`)
  - Plugins: `@tailwindcss/vite`, `@react-router/dev/vite`, `vite-tsconfig-paths`.
- **Routing config**: `react-router.config.ts` sets `ssr: false` (SPA mode).
- **TypeScript config**: `tsconfig.json`
  - Path alias `~/*` → `./app/*` (used widely, e.g. `~/lib/puter`).
  - `rootDirs` includes `.react-router/types` so generated route types integrate cleanly.

### Routing & entry points

- **Route manifest**: `app/routes.ts`
  - `index("routes/home.tsx")` → `/` (home dashboard)
  - `route('/auth', 'routes/auth.tsx')` → `/auth`
  - `route('/upload', 'routes/upload.tsx')` → `/upload`
  - `route('/resume/:id', 'routes/resume.tsx')` → `/resume/:id`
  - `route('/wipe', 'routes/wipe.tsx')` → `/wipe` (data management utility)
- **Root layout & shell**: `app/root.tsx`
  - `Layout` wraps the app with `<html>`/`<body>`, injects Google Fonts via `links()`.
  - Loads global styles via `import "./app.css"`.
  - Inserts the Puter.js script tag: `<script src="https://js.puter.com/v2/"></script>`.
  - Calls `usePuterStore().init()` in a `useEffect` to bootstrap the Puter integration.
  - Exposes a custom `ErrorBoundary` that renders simple error/404 pages.

**Implementation guidance:** when adding new routes, define them in `app/routes.ts` and create corresponding `app/routes/*.tsx` files using the `Route`-typed helpers generated by React Router where appropriate.

### Puter.js integration & global state

Centralized Puter integration lives in `app/lib/puter.ts` and is exposed as a Zustand store:

- `usePuterStore` state shape (key parts):
  - `isLoading`, `error`, `puterReady` flags for global Puter status.
  - `auth`: handles user auth lifecycle
    - `user`, `isAuthenticated`
    - `signIn()`, `signOut()`, `refreshUser()`, `checkAuthStatus()`, `getUser()`
  - `fs`: file operations
    - `write(path, data)`, `read(path)`, `upload(files)`, `delete(path)`, `readDir(path)`
  - `ai`: AI operations
    - `chat(prompt, imageURL?, testMode?, options?)`
    - `feedback(path, message)` – higher-level helper that composes a file + text message and calls `puter.ai.chat` with model `claude-3-7-sonnet`.
    - `img2txt(image, testMode?)`
  - `kv`: key-value utilities
    - `get(key)`, `set(key, value)`, `delete(key)`, `list(pattern, returnValues?)`, `flush()`
  - `init()`: called from `Layout` to detect when `window.puter` is available, then run `checkAuthStatus()`.

`getPuter()` safely accesses `window.puter`, and every operation defensively sets a user-visible `error` if Puter isn’t available.

**Implementation guidance:**

- Always go through `usePuterStore` rather than directly touching `window.puter` in components.
- For new features that need Puter capabilities (files, AI, KV), extend the store here instead of scattering raw `window.puter` calls.
- Respect `puterReady` and `isLoading` in UI layers when triggering auth flows or operations.

### Types and AI response format

Global domain types are declared in `types/index.d.ts`:

- `Resume` – persists metadata and AI `Feedback` for each resume.
- `Feedback` – structured result of an AI analysis, matching what UI components expect (overall score plus per-category scores and tips for ATS, tone/style, content, structure, skills).

`constants/index.ts` defines:

- `AIResponseFormat`: a TypeScript-like interface string showing the exact `Feedback` structure, used inside the AI prompt.
- `prepareInstructions({ jobTitle, jobDescription })`: builds a detailed instruction string for Claude, including the job context and the `AIResponseFormat`. It explicitly instructs the model to:
  - Return **only** a JSON object (no backticks, no extra commentary).
  - Fill the `Feedback` structure completely.

This assumption is relied on in `app/routes/upload.tsx`, which parses the AI response with `JSON.parse` and will throw if extra text is included.

**Implementation guidance:** if you change the `Feedback` type or prompt format, update **all of**:

- `types/index.d.ts` `Feedback`
- `constants/index.ts` `AIResponseFormat` and `prepareInstructions`
- Any parsing/usage of `feedback` in routes and components (e.g. `upload.tsx`, `resume.tsx`, `components/ATS.tsx`, `components/Summary.tsx`, `components/Details.tsx`).

### Resume analysis flow (end-to-end)

The main product flow spans several routes and Puter helpers:

1. **Authentication (`/auth`)** – `app/routes/auth.tsx`
   - Uses `usePuterStore` to obtain `{ isLoading, auth, puterReady, error }`.
   - Parses a `next` query param and redirects an already-authenticated user to that URL.
   - `handleSignIn`:
     - Blocks sign-in until `puterReady` is true.
     - Calls `auth.signIn()` to trigger Puter’s auth modal.
   - UI is a split-screen layout with branding on the left and auth on the right, displaying error and loading states.

2. **Home Dashboard (`/`)** – `app/routes/home.tsx`
   - On mount, if `auth.isAuthenticated` is false, navigates to `/auth?next=/`.
   - Fetches stored resumes from Puter KV via `kv.list('resume:*', true)`.
     - Expects a list of `KVItem` with a JSON `value` field; parsed into `Resume` objects.
   - Renders `ResumeCard` components for each resume; otherwise shows an empty state encouraging upload.

3. **Upload & analysis (`/upload`)** – `app/routes/upload.tsx`
   - UI: job/company form + `FileUploader` component.
   - `FileUploader` (`app/components/FileUploader.tsx`):
     - Uses `react-dropzone` to accept a single PDF up to 20MB.
     - Calls `onFileSelect(file | null)` and shows a selected-file UI using `formatSize` from `app/lib/utils.ts`.
   - `handleAnalyze` orchestrates the pipeline:
     1. **Upload PDF** via `fs.upload([file])`; store returned `uploadedFile.path`.
     2. **Convert PDF → image** via `convertPdfToImage(file)` from `app/lib/pdf2img.ts`.
        - Uses `pdfjs-dist/build/pdf.mjs` dynamically and sets `GlobalWorkerOptions.workerSrc = "/pdf.worker.min.mjs"`.
        - Renders the first page at a high scale into a `<canvas>`, then exports a PNG `File`.
     3. **Upload image** via `fs.upload([imageFile])`; capture `uploadedImage.path`.
     4. **Persist initial metadata** in KV under `resume:{uuid}` using `generateUUID()` from `app/lib/utils.ts`.
     5. **Call AI**: `ai.feedback(uploadedFile.path, prepareInstructions({ jobTitle, jobDescription }))`.
        - Expects `feedback.message.content` to be either a string of JSON or an array with `.text` containing JSON.
        - Parses into a `Feedback` object and updates the KV record.
     6. **Navigate** to `/resume/{uuid}` when analysis completes.

4. **Result view (`/resume/:id`)** – `app/routes/resume.tsx`
   - Protects the route: if not authenticated (and not loading), redirects to `/auth?next=/resume/{id}`.
   - Loads the resume record from KV: `kv.get('resume:{id}')` → JSON `Resume`.
   - Reads file content from Puter FS:
     - `fs.read(data.resumePath)` → Blob → `URL.createObjectURL(pdfBlob)` for the resume link.
     - `fs.read(data.imagePath)` → Blob → `URL.createObjectURL(imageBlob)` for the on-page image.
   - Renders a split layout:
     - Left: sticky visual resume preview that links to the full PDF.
     - Right: `Summary`, `ATS`, and `Details` components driven by `feedback`.

5. **Data management (`/wipe`)** – `app/routes/wipe.tsx`
   - Diagnostic/utility route to inspect and wipe stored data.
   - Uses `fs.readDir("./")` to list FS items, and `fs.delete(file.path)` + `kv.flush()` to clear both files and KV records.

**Implementation guidance:**

- When adding new flows that must persist data, prefer using Puter KV (`kv`) for metadata and Puter FS (`fs`) for file blobs, following the patterns above.
- For any auth-protected route, mirror the guard patterns used in `home.tsx` and `resume.tsx` (redirect to `/auth?next=...`).

### Utility modules & components

- **`app/lib/utils.ts`**
  - `cn(...inputs)` – Tailwind/clsx helper combining `clsx` and `tailwind-merge`.
  - `formatSize(bytes)` – converts byte counts to human-readable sizes.
  - `generateUUID()` – wraps `crypto.randomUUID()`.
- **`app/lib/pdf2img.ts`**
  - Handles lazy loading of `pdfjs-dist` and the PDF→PNG conversion.
  - Maintains a module-level `loadPromise` and `pdfjsLib` cache to avoid duplicate loads.
  - If you change the path to the worker script, update `GlobalWorkerOptions.workerSrc` accordingly.
- **Components directory (`app/components/`)**
  - Contains presentational components for the dashboard and results views.
  - Key pieces include the navbar, logo, score visualizations (gauge, circle, badges), accordion-based detail sections, and the `FileUploader` described above.

### Seed data & constants

- `constants/index.ts` also includes a `resumes` array pointing at static image and PDF assets under `public/images` and `/resumes`. This appears to be demo/seed data for UI and does **not** drive the main Puter-backed flow.

If you need static/demo resumes (e.g. for storybook or offline demos), you can reuse this structure; production flows should rely on Puter KV/FS instead.
